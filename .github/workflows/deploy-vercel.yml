name: ğŸ¨ DÃ©ploiement Automatique Vercel

on:
  push:
    branches: [main, dockerfile]
    paths:
      - 'apps/**'
      - 'packages/**'
  workflow_dispatch:
    inputs:
      app:
        description: 'Application Ã  dÃ©ployer'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - web-industry
          - web-transporter
          - web-logistician
          - web-recipient
          - web-supplier
          - web-forwarder
          - backoffice-admin
          - marketing-site

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy:
    name: DÃ©ploiement Vercel
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node + PNPM
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ”§ Enable PNPM
        run: corepack enable && pnpm -v

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ğŸ” DÃ©tection des applications modifiÃ©es
        if: github.event_name == 'push'
        id: changed-apps
        run: |
          echo "Analyse des fichiers modifiÃ©s..."
          CHANGED_APPS=""

          # VÃ©rifier si on peut comparer avec HEAD~1
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            # VÃ©rifier chaque application
            for APP in web-industry web-transporter web-logistician web-recipient web-supplier web-forwarder backoffice-admin marketing-site; do
              if git diff --name-only HEAD~1 HEAD | grep -q "^apps/$APP/"; then
                CHANGED_APPS="$CHANGED_APPS $APP"
                echo "âœ… $APP modifiÃ©"
              fi
            done

            # Si packages modifiÃ©s, redÃ©ployer toutes les apps
            if git diff --name-only HEAD~1 HEAD | grep -q "^packages/"; then
              CHANGED_APPS="web-industry web-transporter web-logistician web-recipient web-supplier web-forwarder backoffice-admin marketing-site"
              echo "ğŸ“¦ Packages modifiÃ©s - redÃ©ploiement complet"
            fi
          else
            # Premier commit sur cette branche - dÃ©ployer toutes les apps
            CHANGED_APPS="web-industry web-transporter web-logistician web-recipient web-supplier web-forwarder backoffice-admin marketing-site"
            echo "ğŸ†• Premier dÃ©ploiement - toutes les applications"
          fi

          if [ -z "$CHANGED_APPS" ]; then
            echo "Aucune application modifiÃ©e"
            echo "apps=none" >> $GITHUB_OUTPUT
          else
            echo "Applications Ã  dÃ©ployer:$CHANGED_APPS"
            echo "apps=$CHANGED_APPS" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ DÃ©ploiement web-industry
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-industry')) ||
          (github.event.inputs.app == 'web-industry') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ­ DÃ©ploiement web-industry"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-industry
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement web-transporter
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-transporter')) ||
          (github.event.inputs.app == 'web-transporter') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸšš DÃ©ploiement web-transporter"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-transporter
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement web-logistician
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-logistician')) ||
          (github.event.inputs.app == 'web-logistician') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ DÃ©ploiement web-logistician"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-logistician
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement web-recipient
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-recipient')) ||
          (github.event.inputs.app == 'web-recipient') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¥ DÃ©ploiement web-recipient"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-recipient
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement web-supplier
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-supplier')) ||
          (github.event.inputs.app == 'web-supplier') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸª DÃ©ploiement web-supplier"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-supplier
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement web-forwarder
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'web-forwarder')) ||
          (github.event.inputs.app == 'web-forwarder') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœˆï¸ DÃ©ploiement web-forwarder"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/web-forwarder
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸš€ DÃ©ploiement backoffice-admin
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'backoffice-admin')) ||
          (github.event.inputs.app == 'backoffice-admin') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ DÃ©ploiement backoffice-admin"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/backoffice-admin
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          NEXT_PUBLIC_ADMIN_GATEWAY_URL: ${{ secrets.NEXT_PUBLIC_ADMIN_GATEWAY_URL }}
          NEXT_PUBLIC_AUTHZ_URL: ${{ secrets.NEXT_PUBLIC_AUTHZ_URL }}
          NEXT_PUBLIC_SUPPORT_URL: ${{ secrets.NEXT_PUBLIC_SUPPORT_URL }}

      - name: ğŸš€ DÃ©ploiement marketing-site
        if: |
          (github.event_name == 'push' && contains(steps.changed-apps.outputs.apps, 'marketing-site')) ||
          (github.event.inputs.app == 'marketing-site') ||
          (github.event.inputs.app == 'all')
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ DÃ©ploiement marketing-site"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cd apps/marketing-site
          pnpm build
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

      - name: ğŸ“Š RÃ©sumÃ© Final
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT VERCEL"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”— Dashboard Vercel:"
          echo "   https://vercel.com/dashboard"
          echo ""
          echo "âœ… DÃ©ploiement terminÃ© !"

