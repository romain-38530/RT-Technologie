name: ü§ñ Manager AI - Monitoring Complet

on:
  workflow_run:
    workflows: ["üöÄ D√©ploiement Automatique AWS", "üé® D√©ploiement Automatique Vercel"]
    types:
      - completed
      - in_progress

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîç Analyse Compl√®te du Workflow
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // R√©cup√©rer les d√©tails du workflow
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // R√©cup√©rer tous les jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const status = context.payload.workflow_run.conclusion || 'in_progress';
            const isFailure = status === 'failure';
            const isSuccess = status === 'success';

            let report = `# ${isFailure ? 'üî¥' : isSuccess ? '‚úÖ' : '‚è≥'} Rapport de D√©ploiement\n\n`;
            report += `## üìä Informations G√©n√©rales\n\n`;
            report += `- **Workflow:** ${context.payload.workflow_run.name}\n`;
            report += `- **Statut:** ${status.toUpperCase()}\n`;
            report += `- **Branche:** ${context.payload.workflow_run.head_branch}\n`;
            report += `- **Commit:** \`${context.payload.workflow_run.head_sha.substring(0, 7)}\`\n`;
            report += `- **Auteur:** ${context.payload.workflow_run.head_commit.author.name}\n`;
            report += `- **Message:** ${context.payload.workflow_run.head_commit.message}\n`;
            report += `- **Dur√©e:** ${Math.round((new Date(context.payload.workflow_run.updated_at) - new Date(context.payload.workflow_run.created_at)) / 1000 / 60)} minutes\n`;
            report += `- **URL:** ${context.payload.workflow_run.html_url}\n\n`;

            report += `## üìã D√©tails des Jobs\n\n`;

            for (const job of jobs.data.jobs) {
              const jobStatus = job.conclusion || 'in_progress';
              const emoji = jobStatus === 'success' ? '‚úÖ' : jobStatus === 'failure' ? '‚ùå' : '‚è≥';

              report += `### ${emoji} ${job.name}\n\n`;
              report += `- **Statut:** ${jobStatus}\n`;
              report += `- **Dur√©e:** ${job.completed_at ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000) : 'En cours'}s\n`;
              report += `- **URL:** ${job.html_url}\n\n`;

              // D√©tails des √©tapes
              if (job.steps && job.steps.length > 0) {
                report += `#### √âtapes:\n\n`;
                for (const step of job.steps) {
                  const stepEmoji = step.conclusion === 'success' ? '‚úÖ' : step.conclusion === 'failure' ? '‚ùå' : '‚è≥';
                  const duration = step.completed_at ? Math.round((new Date(step.completed_at) - new Date(step.started_at)) / 1000) : 'En cours';
                  report += `${stepEmoji} **${step.name}** - ${duration}s\n`;
                }
                report += `\n`;
              }

              // R√©cup√©rer les logs pour les jobs √©chou√©s
              if (jobStatus === 'failure') {
                report += `#### üìú Logs Complets:\n\n`;
                try {
                  const logsResponse = await github.rest.actions.downloadJobLogsForWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    job_id: job.id
                  });

                  // Les logs sont retourn√©s comme du texte
                  const logs = logsResponse.data;

                  // Extraire les 200 derni√®res lignes (les plus pertinentes)
                  const logLines = logs.toString().split('\n');
                  const relevantLogs = logLines.slice(-200).join('\n');

                  report += `\`\`\`\n${relevantLogs}\n\`\`\`\n\n`;
                } catch (error) {
                  report += `_Impossible de r√©cup√©rer les logs: ${error.message}_\n\n`;
                }
              }
            }

            // Diagnostic AWS si √©chec
            if (isFailure && context.payload.workflow_run.name.includes('AWS')) {
              report += `## üîç Diagnostic AWS Automatique\n\n`;
              report += `### Actions Recommand√©es:\n\n`;
              report += `1. V√©rifier les images dans ECR:\n`;
              report += `\`\`\`bash\n`;
              report += `# Dans AWS CloudShell\n`;
              report += `for SERVICE in tms-sync erp-sync palette tracking-ia planning notifications admin-gateway authz training geo-tracking storage-market; do\n`;
              report += `  aws ecr describe-images --repository-name rt-$SERVICE --region eu-central-1 --query 'images[0].imageTags[0]' --output text\n`;
              report += `done\n`;
              report += `\`\`\`\n\n`;
              report += `2. V√©rifier les services ECS:\n`;
              report += `\`\`\`bash\n`;
              report += `aws ecs list-services --cluster rt-production --region eu-central-1\n`;
              report += `\`\`\`\n\n`;
              report += `3. Consulter les logs de l'instance EC2:\n`;
              report += `\`\`\`bash\n`;
              report += `aws ssm send-command --instance-ids i-0ece63fb077366323 --document-name "AWS-RunShellScript" --parameters 'commands=["tail -100 /home/ec2-user/deploy.log"]' --region eu-central-1\n`;
              report += `\`\`\`\n\n`;
            }

            // Diagnostic Vercel si √©chec
            if (isFailure && context.payload.workflow_run.name.includes('Vercel')) {
              report += `## üîç Diagnostic Vercel Automatique\n\n`;
              report += `### Actions Recommand√©es:\n\n`;
              report += `1. V√©rifier les d√©ploiements r√©cents:\n`;
              report += `   - Dashboard Vercel: https://vercel.com/dashboard\n\n`;
              report += `2. V√©rifier les secrets GitHub:\n`;
              report += `   - VERCEL_TOKEN\n`;
              report += `   - VERCEL_ORG_ID\n\n`;
              report += `3. V√©rifier la configuration PNPM:\n`;
              report += `   - Tester localement: \`pnpm install && pnpm build\`\n\n`;
            }

            // Ajouter une section "Prochaines √âtapes"
            if (isFailure) {
              report += `## üéØ Prochaines √âtapes pour Claude (Manager AI)\n\n`;
              report += `1. ‚úÖ Analyser les logs ci-dessus\n`;
              report += `2. ‚úÖ Identifier la cause racine de l'√©chec\n`;
              report += `3. ‚úÖ Proposer un correctif automatique si possible\n`;
              report += `4. ‚úÖ Cr√©er un commit avec le fix\n`;
              report += `5. ‚úÖ Relancer le d√©ploiement\n\n`;
              report += `**Instructions pour Romain:** Partagez-moi le lien de cette Issue et je m'occupe du reste !\n\n`;
            } else if (isSuccess) {
              report += `## üéâ D√©ploiement R√©ussi !\n\n`;
              report += `Toutes les √©tapes ont √©t√© compl√©t√©es avec succ√®s.\n\n`;
            }

            // Sauvegarder le rapport
            fs.writeFileSync('deployment-report.md', report);

            return {
              status: status,
              isFailure: isFailure,
              isSuccess: isSuccess,
              title: `${isFailure ? 'üî¥' : isSuccess ? '‚úÖ' : '‚è≥'} D√©ploiement ${context.payload.workflow_run.name} - ${status}`
            };

      - name: üì§ Cr√©er/Mettre √† jour l'Issue de Monitoring
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('deployment-report.md', 'utf8');
            const status = '${{ steps.analyze.outputs.status }}';
            const isFailure = '${{ steps.analyze.outputs.isFailure }}' === 'true';
            const title = `${{ steps.analyze.outputs.title }}`;

            // Chercher une issue existante pour ce workflow run
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'deployment-monitoring',
              state: 'open',
              per_page: 10
            });

            // Cr√©er une nouvelle issue
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: report,
              labels: isFailure ? ['deployment-monitoring', 'deployment-failure', 'needs-fix'] : ['deployment-monitoring', 'deployment-success']
            });

            console.log(`Issue cr√©√©e: ${newIssue.data.html_url}`);

            // Si c'est un succ√®s, fermer automatiquement apr√®s 1 minute
            if (!isFailure) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: newIssue.data.number,
                state: 'closed'
              });
            }

      - name: üí¨ Commentaire sur le Commit
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('deployment-report.md', 'utf8');

            // Limiter la taille du commentaire (GitHub limite √† 65536 caract√®res)
            const maxLength = 60000;
            const shortReport = report.length > maxLength
              ? report.substring(0, maxLength) + '\n\n... (rapport tronqu√©, voir l\'Issue compl√®te)'
              : report;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.workflow_run.head_sha,
              body: shortReport + `\n\n---\n_ü§ñ Rapport g√©n√©r√© automatiquement par le Manager AI_`
            });

      - name: üìä Upload du Rapport Complet
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.run_id }}
          path: deployment-report.md
          retention-days: 30
