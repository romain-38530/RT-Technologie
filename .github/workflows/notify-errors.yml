name: üì¢ Notification des Erreurs

on:
  workflow_run:
    workflows: ["üöÄ D√©ploiement Automatique AWS", "üé® D√©ploiement Automatique Vercel"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: üì• R√©cup√©rer les logs d'erreur
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // R√©cup√©rer les d√©tails du workflow √©chou√©
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // R√©cup√©rer les jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Trouver les jobs √©chou√©s
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let errorReport = `# ‚ùå Erreur de D√©ploiement\n\n`;
            errorReport += `**Workflow:** ${context.payload.workflow_run.name}\n`;
            errorReport += `**Branche:** ${context.payload.workflow_run.head_branch}\n`;
            errorReport += `**Commit:** ${context.payload.workflow_run.head_sha.substring(0, 7)}\n`;
            errorReport += `**URL:** ${context.payload.workflow_run.html_url}\n\n`;

            for (const job of failedJobs) {
              errorReport += `## Job √©chou√©: ${job.name}\n\n`;

              // R√©cup√©rer les logs du job
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });

                errorReport += `\`\`\`\n${logs.data}\n\`\`\`\n\n`;
              } catch (error) {
                errorReport += `_Logs non disponibles_\n\n`;
              }

              // Ajouter les √©tapes √©chou√©es
              const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
              for (const step of failedSteps) {
                errorReport += `### ‚ùå √âtape √©chou√©e: ${step.name}\n`;
                errorReport += `- **Dur√©e:** ${step.completed_at ? ((new Date(step.completed_at) - new Date(step.started_at)) / 1000).toFixed(0) : 'N/A'}s\n`;
                errorReport += `- **Num√©ro:** ${step.number}\n\n`;
              }
            }

            // Sauvegarder le rapport
            fs.writeFileSync('error-report.md', errorReport);

            console.log(errorReport);

      - name: üì§ Cr√©er une Issue avec les d√©tails de l'erreur
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorReport = fs.readFileSync('error-report.md', 'utf8');

            // Cr√©er une issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ √âchec du d√©ploiement - ${context.payload.workflow_run.name}`,
              body: errorReport,
              labels: ['deployment-failure', 'automated']
            });

      - name: üí¨ Commentaire sur le dernier commit
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorReport = fs.readFileSync('error-report.md', 'utf8');

            // Cr√©er un commentaire sur le commit
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.workflow_run.head_sha,
              body: `## ‚ö†Ô∏è D√©ploiement √©chou√©\n\n${errorReport}\n\n_Ce commentaire a √©t√© g√©n√©r√© automatiquement par GitHub Actions_`
            });
